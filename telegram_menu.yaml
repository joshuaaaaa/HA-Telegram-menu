# packages/telegram_menu.yaml

automation:
  # HLAVNÃ MENU - COMMAND
  - alias: "Telegram: HlavnÃ­ menu tlaÄidiel"
    trigger:
      - platform: event
        event_type: telegram_command
        event_data:
          command: /menu
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          message: "ğŸ  HlavnÃ­ menu Home Assistant"
          inline_keyboard:
            - "ğŸ“¡ SÃ­Å¥:/callback_siet, ğŸ“Š Stav:/status"
            - "âš¡ Elektrika:/callback_elektrika, ğŸŒ¤ PoÄasÃ­:/thp"
            - "ğŸ’¡ SvÄ›tla:/callback_lights, ğŸ”¥ TopenÃ­:/callback_heating"
            - "ğŸ”’ ZabezpeÄenÃ­:/callback_security, ğŸ”Œ Switche:/callback_switches"
            - "ğŸ”‹ Baterie:/callback_batteries, ğŸ“± SystÃ©m:/callback_system"
            - "ğŸµ MÃ©dia:/callback_media, âš ï¸ UpozornÄ›nÃ­:/callback_alerts"
            - "ğŸ¬ ScÃ©ny:/callback_scenes, ğŸ¤– Automatizace:/callback_automations"
            - "ğŸ†• Updaty:/callback_updates, ğŸ“ˆ Statistiky:/callback_stats"
            - "ğŸ‘¥ Osoby:/callback_persons, ğŸ“… KalendÃ¡Å™:/callback_calendar"
            - "ğŸŒ… Slunce:/callback_sun, ğŸ—’ï¸ Notifikace:/callback_notifications"
            - "ğŸ“· Kamery:/callback_cameras, ğŸªŸ Covers:/callback_covers"
            - "ğŸ’¨ VentilÃ¡tory:/callback_fans, ğŸŒ¡ï¸ ZvlhÄovaÄe:/callback_humidifiers"

  # HLAVNÃ MENU - CALLBACK
  - alias: "Telegram: Menu callback"
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_menu
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          message: "ğŸ  HlavnÃ­ menu Home Assistant"
          inline_keyboard:
            - "ğŸ“¡ SÃ­Å¥:/callback_siet, ğŸ“Š Stav:/status"
            - "âš¡ Elektrika:/callback_elektrika, ğŸŒ¤ PoÄasÃ­:/thp"
            - "ğŸ’¡ SvÄ›tla:/callback_lights, ğŸ”¥ TopenÃ­:/callback_heating"
            - "ğŸ”’ ZabezpeÄenÃ­:/callback_security, ğŸ”Œ Switche:/callback_switches"
            - "ğŸ”‹ Baterie:/callback_batteries, ğŸ“± SystÃ©m:/callback_system"
            - "ğŸµ MÃ©dia:/callback_media, âš ï¸ UpozornÄ›nÃ­:/callback_alerts"
            - "ğŸ¬ ScÃ©ny:/callback_scenes, ğŸ¤– Automatizace:/callback_automations"
            - "ğŸ†• Updaty:/callback_updates, ğŸ“ˆ Statistiky:/callback_stats"
            - "ğŸ‘¥ Osoby:/callback_persons, ğŸ“… KalendÃ¡Å™:/callback_calendar"
            - "ğŸŒ… Slunce:/callback_sun, ğŸ—’ï¸ Notifikace:/callback_notifications"
            - "ğŸ“· Kamery:/callback_cameras, ğŸªŸ Covers:/callback_covers"
            - "ğŸ’¨ VentilÃ¡tory:/callback_fans, ğŸŒ¡ï¸ ZvlhÄovaÄe:/callback_humidifiers"

  - alias: Telegram switches seznam
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_switches
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ”Œ PÅ™ehled switchÅ¯:</b>
            
            {% set on = states.switch | selectattr('state','eq','on') | list %}
            {% set off = states.switch | selectattr('state','eq','off') | list %}
            
            <b>âœ… ZapnutÃ© ({{ on|count }}):</b>
            {% if on | count == 0 %}
            Å½Ã¡dnÃ½
            {% else %}
            {% for s in on %}
            â€¢ {{ s.name }}
              â”” Zapnuto: {{ relative_time(s.last_changed) }}
              {% if s.attributes.current_power_w %}â”” SpotÅ™eba: {{ s.attributes.current_power_w }}W{% endif %}
            {% endfor %}
            {% endif %}
            
            <b>â­• VypnutÃ© ({{ off|count }}):</b>
            {% if off|count > 5 %}
            ({{ off|count }} zaÅ™Ã­zenÃ­)
            {% else %}
            {% for s in off %}
            â€¢ {{ s.name }}
            {% endfor %}
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_switches, ğŸ  Menu:/callback_menu"

  - alias: Telegram home status
    trigger:
      - platform: event
        event_type: telegram_command
        event_data:
          command: /status
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ  Status domÃ¡cnosti</b>
            
            ğŸŒ¡ <b>Teploty:</b>
            {% for sensor in states.sensor | selectattr('attributes.device_class','eq','temperature') | list %}
            â€¢ {{ sensor.name }}: {{ sensor.state }}Â°C
            {% endfor %}
            
            âš¡ <b>Energie:</b>
            â€¢ SpotÅ™eba: {{ states('sensor.electricity_power')|float(0)|round(0) }} W
            â€¢ Dnes: {{ states('sensor.electricity_daily')|float(0)|round(2) }} kWh
            
            ğŸ”Œ <b>ZaÅ™Ã­zenÃ­:</b>
            â€¢ ZapnutÃ©: {{ states.switch|selectattr('state','eq','on')|list|count }}
            â€¢ SvÄ›tla: {{ states.light|selectattr('state','eq','on')|list|count }}
            
            ğŸ‘¥ <b>Osoby:</b>
            {% for person in states.person %}
            â€¢ {{ person.name }}: {{ person.state }}
            {% endfor %}

  - alias: Telegram THP pÅ™ehled
    trigger:
      - platform: event
        event_type: telegram_command
        event_data:
          command: /thp
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸŒ¡ Teplota / Vlhkost / Tlak</b>
            
            {% for sensor in states.sensor 
               | selectattr('attributes.device_class','defined') 
               | list %}
            {% if sensor.attributes.device_class in ['temperature','humidity','pressure'] %}
            {{ sensor.attributes.device_class[0]|upper }}| {{ sensor.name }}: {{ sensor.state }} {{ sensor.attributes.unit_of_measurement }}
            {% endif %}
            {% endfor %}

  - alias: Telegram sÃ­Å¥ pÅ™ehled
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_siet
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ“¡ SÃ­Å¥ a pÅ™ipojenÃ­</b>
            
            {% set devices = states.device_tracker | selectattr('state','eq','home') | list %}
            {% if devices | count > 0 %}
            <b>ğŸ  Doma ({{ devices|count }}):</b>
            {% for device in devices %}
            â€¢ {{ device.name }}
              {% if device.attributes.ip is defined %}â”” IP: {{ device.attributes.ip }}{% endif %}
            {% endfor %}
            {% else %}
            <b>ğŸ  Å½Ã¡dnÃ¡ zaÅ™Ã­zenÃ­ doma</b>
            {% endif %}
            
            {% set speedtest = states.sensor | selectattr('entity_id', 'search', 'speedtest') | list %}
            {% if speedtest | count > 0 %}
            <b>ğŸŒ Rychlost internetu:</b>
            {% for s in speedtest %}
            {% if 'download' in s.entity_id and s.state != 'unknown' %}
            â€¢ Download: {{ s.state|float(0)|round(1) }} {{ s.attributes.unit_of_measurement }}
            {% elif 'upload' in s.entity_id and s.state != 'unknown' %}
            â€¢ Upload: {{ s.state|float(0)|round(1) }} {{ s.attributes.unit_of_measurement }}
            {% elif 'ping' in s.entity_id and s.state != 'unknown' %}
            â€¢ Ping: {{ s.state|float(0)|round(0) }} {{ s.attributes.unit_of_measurement }}
            {% endif %}
            {% endfor %}
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_siet, ğŸ  Menu:/callback_menu"

  - alias: Telegram elektrika detail
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_elektrika
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>âš¡ SpotÅ™eba elektÅ™iny</b>
            
            {% set power_sensors = states.sensor | selectattr('attributes.device_class','eq','power') | list %}
            {% set energy_sensors = states.sensor | selectattr('attributes.device_class','eq','energy') | list %}
            {% set voltage_sensors = states.sensor | selectattr('attributes.device_class','eq','voltage') | list %}
            {% set current_sensors = states.sensor | selectattr('attributes.device_class','eq','current') | list %}
            
            {% if power_sensors | count > 0 %}
            <b>ğŸ“Š AktuÃ¡lnÃ­ vÃ½kon:</b>
            {% for s in power_sensors %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ {{ s.name }}: {{ s.state|float(0)|round(0) }} W
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% if voltage_sensors | count > 0 %}
            {% for s in voltage_sensors %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ NapÄ›tÃ­: {{ s.state|float(0)|round(0) }} V
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% if current_sensors | count > 0 %}
            {% for s in current_sensors %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ Proud: {{ s.state|float(0)|round(2) }} A
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% if energy_sensors | count > 0 %}
            <b>ğŸ“… SpotÅ™eba energie:</b>
            {% for s in energy_sensors | sort(attribute='entity_id') %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ {{ s.name }}: {{ s.state|float(0)|round(2) }} {{ s.attributes.unit_of_measurement }}
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set top_consumers = states.switch | selectattr('state','eq','on') | selectattr('attributes.current_power_w','defined') | sort(attribute='attributes.current_power_w', reverse=true) | list %}
            {% if top_consumers | count > 0 %}
            <b>ğŸ”Œ Top spotÅ™ebiÄe:</b>
            {% for switch in top_consumers[:5] %}
            â€¢ {{ switch.name }}: {{ switch.attributes.current_power_w }}W
            {% endfor %}
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_elektrika, ğŸ  Menu:/callback_menu"

  - alias: Telegram svetla prehled
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_lights
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ’¡ PÅ™ehled svÄ›tel</b>
            
            {% set on = states.light | selectattr('state','eq','on') | list %}
            {% set off = states.light | selectattr('state','eq','off') | list %}
            
            {% if (on|count + off|count) == 0 %}
            <i>Å½Ã¡dnÃ¡ svÄ›tla nenalezena</i>
            {% else %}
            <b>âœ… ZapnutÃ© ({{ on|count }}):</b>
            {% if on | count == 0 %}
            Å½Ã¡dnÃ©
            {% else %}
            {% for light in on %}
            â€¢ {{ light.name }}
              {% if light.attributes.brightness is defined %}â”” Jas: {{ ((light.attributes.brightness / 255) * 100)|round(0) }}%{% endif %}
              {% if light.attributes.color_temp is defined %}â”” Teplota: {{ light.attributes.color_temp }}K{% endif %}
            {% endfor %}
            {% endif %}
            
            <b>â­• VypnutÃ© ({{ off|count }}):</b>
            {% if off|count > 5 %}
            ({{ off|count }} svÄ›tel)
            {% else %}
            {% for light in off %}
            â€¢ {{ light.name }}
            {% endfor %}
            {% endif %}
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_lights, ğŸ  Menu:/callback_menu"

  - alias: Telegram topeni prehled
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_heating
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ”¥ TopenÃ­ a teploty</b>
            
            {% set temp_sensors = states.sensor | selectattr('attributes.device_class','eq','temperature') | list %}
            {% if temp_sensors | count > 0 %}
            <b>ğŸŒ¡ Teploty mÃ­stnostÃ­:</b>
            {% for sensor in temp_sensors %}
            {% if sensor.state != 'unknown' and sensor.state != 'unavailable' %}
            â€¢ {{ sensor.name }}: {{ sensor.state }}Â°C
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set climates = states.climate | list %}
            {% if climates | count > 0 %}
            <b>ğŸ”¥ Termostaty:</b>
            {% for climate in climates %}
            {% if climate.state != 'unavailable' %}
            â€¢ {{ climate.name }}
              â”” ReÅ¾im: {{ climate.state }}
              {% if climate.attributes.temperature is defined %}â”” CÃ­lovÃ¡: {{ climate.attributes.temperature }}Â°C{% endif %}
              {% if climate.attributes.current_temperature is defined %}â”” AktuÃ¡lnÃ­: {{ climate.attributes.current_temperature }}Â°C{% endif %}
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set heat_pump_sensors = states.sensor | selectattr('entity_id', 'search', 'heat_pump|cop|cerpadlo') | list %}
            {% if heat_pump_sensors | count > 0 %}
            <b>ğŸ”„ TepelnÃ© Äerpadlo:</b>
            {% for s in heat_pump_sensors %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ {{ s.name }}: {{ s.state }} {{ s.attributes.unit_of_measurement|default('') }}
            {% endif %}
            {% endfor %}
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_heating, ğŸ  Menu:/callback_menu"

  - alias: Telegram zabezpeceni
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_security
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ”’ ZabezpeÄenÃ­</b>
            
            {% set doors = states.binary_sensor | selectattr('attributes.device_class','eq','door') | list %}
            {% set windows = states.binary_sensor | selectattr('attributes.device_class','eq','window') | list %}
            {% if (doors|count + windows|count) > 0 %}
            <b>ğŸšª DveÅ™e a okna:</b>
            {% for sensor in doors + windows %}
            {% if sensor.state != 'unavailable' %}
            â€¢ {{ sensor.name }}: {{ 'ğŸ”“ OtevÅ™eno' if sensor.state == 'on' else 'ğŸ”’ ZavÅ™eno' }}
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set smoke = states.binary_sensor | selectattr('attributes.device_class','eq','smoke') | list %}
            {% set motion = states.binary_sensor | selectattr('attributes.device_class','eq','motion') | list %}
            {% if (smoke|count + motion|count) > 0 %}
            <b>ğŸ” Detektory:</b>
            {% for sensor in smoke %}
            {% if sensor.state != 'unavailable' %}
            â€¢ {{ sensor.name }}: {{ 'âš ï¸ ALARM' if sensor.state == 'on' else 'âœ… OK' }}
            {% endif %}
            {% endfor %}
            {% for sensor in motion %}
            {% if sensor.state != 'unavailable' %}
            â€¢ {{ sensor.name }}: {{ 'ğŸ‘¤ Pohyb' if sensor.state == 'on' else 'âœ… Klid' }}
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set alarms = states.alarm_control_panel | list %}
            {% if alarms | count > 0 %}
            <b>ğŸ›¡ Alarmy:</b>
            {% for alarm in alarms %}
            {% if alarm.state != 'unavailable' %}
            â€¢ {{ alarm.name }}: {{ alarm.state }}
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% if (doors|count + windows|count + smoke|count + motion|count + alarms|count) == 0 %}
            <i>Å½Ã¡dnÃ¡ zabezpeÄovacÃ­ zaÅ™Ã­zenÃ­ nenalezena</i>
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_security, ğŸ  Menu:/callback_menu"

  - alias: Telegram baterie prehled
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_batteries
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ”‹ Stav bateriÃ­</b>
            
            {% set battery_sensors = states.sensor | selectattr('attributes.device_class','eq','battery') | list %}
            {% if battery_sensors | count > 0 %}
            {% set low = battery_sensors | selectattr('state','lt','20') | selectattr('state','ne','unknown') | selectattr('state','ne','unavailable') | list %}
            {% set medium = battery_sensors | selectattr('state','ge','20') | selectattr('state','lt','50') | selectattr('state','ne','unknown') | selectattr('state','ne','unavailable') | list %}
            {% set good = battery_sensors | selectattr('state','ge','50') | selectattr('state','ne','unknown') | selectattr('state','ne','unavailable') | list %}
            
            {% if low | count > 0 %}
            <b>ğŸ”´ KritickÃ© (&lt;20%):</b>
            {% for s in low | sort(attribute='state') %}
            â€¢ {{ s.name }}: {{ s.state }}%
            {% endfor %}
            {% endif %}
            
            {% if medium | count > 0 %}
            <b>ğŸŸ¡ StÅ™ednÃ­ (20-50%):</b>
            {% for s in medium | sort(attribute='state') %}
            â€¢ {{ s.name }}: {{ s.state }}%
            {% endfor %}
            {% endif %}
            
            {% if good | count > 0 %}
            <b>ğŸŸ¢ DobrÃ½ stav (&gt;50%):</b>
            {% if good | count > 10 %}
            ({{ good|count }} zaÅ™Ã­zenÃ­ v poÅ™Ã¡dku)
            {% else %}
            {% for s in good | sort(attribute='state') %}
            â€¢ {{ s.name }}: {{ s.state }}%
            {% endfor %}
            {% endif %}
            {% endif %}
            {% else %}
            <i>Å½Ã¡dnÃ© bateriovÃ© senzory nenalezeny</i>
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_batteries, ğŸ  Menu:/callback_menu"

  - alias: Telegram system info
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_system
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ“± SystÃ©movÃ© informace</b>
            
            <b>ğŸ  Home Assistant:</b>
            â€¢ Verze: {{ states('sensor.current_version') if states('sensor.current_version') != 'unknown' else 'N/A' }}
            {% set uptime = states.sensor | selectattr('entity_id', 'search', 'uptime') | list %}
            {% if uptime | count > 0 %}
            {% for s in uptime %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ Uptime: {{ s.state }}
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set cpu = states.sensor | selectattr('entity_id', 'search', 'processor_use|cpu') | list %}
            {% set memory = states.sensor | selectattr('entity_id', 'search', 'memory_use|ram') | list %}
            {% set disk = states.sensor | selectattr('entity_id', 'search', 'disk_use') | list %}
            
            {% if cpu | count > 0 or memory | count > 0 or disk | count > 0 %}
            <b>âš™ï¸ SystÃ©movÃ© prostÅ™edky:</b>
            {% for s in cpu %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ CPU: {{ s.state }}%
            {% endif %}
            {% endfor %}
            {% for s in memory %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ RAM: {{ s.state }}%
            {% endif %}
            {% endfor %}
            {% for s in disk %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ Disk: {{ s.state }}%
            {% endif %}
            {% endfor %}
            {% endif %}
            
            <b>ğŸ“Š Entity:</b>
            â€¢ Celkem: {{ states | count }}
            â€¢ Sensors: {{ states.sensor | count }}
            â€¢ Switches: {{ states.switch | count }}
            â€¢ Lights: {{ states.light | count }}
            â€¢ Binary sensors: {{ states.binary_sensor | count }}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_system, ğŸ  Menu:/callback_menu"

  - alias: Telegram media prehled
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_media
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸµ MÃ©dia</b>
            
            {% set media = states.media_player | selectattr('state','ne','off') | selectattr('state','ne','unavailable') | list %}
            {% if media | count > 0 %}
            {% for player in media %}
            <b>{{ player.name }}</b>
            â€¢ Stav: {{ player.state }}
            {% if player.attributes.media_title is defined %}
            â€¢ PÅ™ehrÃ¡vÃ¡: {{ player.attributes.media_title }}
            {% endif %}
            {% if player.attributes.media_artist is defined %}
            â€¢ UmÄ›lec: {{ player.attributes.media_artist }}
            {% endif %}
            {% if player.attributes.volume_level is defined %}
            â€¢ Hlasitost: {{ (player.attributes.volume_level * 100)|round(0) }}%
            {% endif %}
            {% if player.attributes.source is defined %}
            â€¢ Zdroj: {{ player.attributes.source }}
            {% endif %}
            
            {% endfor %}
            {% else %}
            <i>Å½Ã¡dnÃ© aktivnÃ­ pÅ™ehrÃ¡vaÄe</i>
            {% endif %}
            
            {% set vacuums = states.vacuum | list %}
            {% if vacuums | count > 0 %}
            <b>ğŸ¤– VysavaÄe:</b>
            {% for vac in vacuums %}
            {% if vac.state != 'unavailable' %}
            â€¢ {{ vac.name }}: {{ vac.state }}
            {% if vac.attributes.battery_level is defined %}  â”” Baterie: {{ vac.attributes.battery_level }}%{% endif %}
            {% endif %}
            {% endfor %}
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_media, ğŸ  Menu:/callback_menu"

  - alias: Telegram upozorneni
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_alerts
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>âš ï¸ UpozornÄ›nÃ­ a varovÃ¡nÃ­</b>
            
            {% set issues = namespace(count=0) %}
            
            {% set low_battery = states.sensor | selectattr('attributes.device_class','eq','battery') | selectattr('state','lt','20') | selectattr('state','ne','unknown') | selectattr('state','ne','unavailable') | list %}
            {% if low_battery | count > 0 %}
            {% set issues.count = issues.count + low_battery|count %}
            <b>ğŸ”‹ SlabÃ© baterie ({{ low_battery|count }}):</b>
            {% for s in low_battery %}
            â€¢ {{ s.name }}: {{ s.state }}%
            {% endfor %}
            {% endif %}
            
            {% set open_doors = states.binary_sensor | selectattr('attributes.device_class','eq','door') | selectattr('state','eq','on') | list %}
            {% set open_windows = states.binary_sensor | selectattr('attributes.device_class','eq','window') | selectattr('state','eq','on') | list %}
            {% if (open_doors|count + open_windows|count) > 0 %}
            {% set issues.count = issues.count + (open_doors|count + open_windows|count) %}
            <b>ğŸ”“ OtevÅ™eno ({{ open_doors|count + open_windows|count }}):</b>
            {% for s in open_doors + open_windows %}
            â€¢ {{ s.name }}
            {% endfor %}
            {% endif %}
            
            {% set lights_on = states.light | selectattr('state','eq','on') | list %}
            {% if lights_on | count > 0 %}
            <b>ğŸ’¡ ZapnutÃ¡ svÄ›tla ({{ lights_on|count }}):</b>
            {% for light in lights_on %}
            â€¢ {{ light.name }}
              â”” {{ relative_time(light.last_changed) }}
            {% endfor %}
            {% endif %}
            
            {% set switches_on = states.switch | selectattr('state','eq','on') | list %}
            {% if switches_on | count > 0 %}
            <b>ğŸ”Œ ZapnutÃ© switche ({{ switches_on|count }}):</b>
            {% for s in switches_on %}
            â€¢ {{ s.name }}
              â”” {{ relative_time(s.last_changed) }}
            {% endfor %}
            {% endif %}
            
            {% set unavailable = states | selectattr('state','eq','unavailable') | list %}
            {% if unavailable | count > 0 %}
            {% set issues.count = issues.count + unavailable|count %}
            <b>âš ï¸ NedostupnÃ© entity ({{ unavailable|count }}):</b>
            {% if unavailable | count > 10 %}
            ({{ unavailable|count }} entit je offline)
            {% else %}
            {% for s in unavailable %}
            â€¢ {{ s.name }}
            {% endfor %}
            {% endif %}
            {% endif %}
            
            {% if issues.count == 0 %}
            <b>âœ… VÅ¡e v poÅ™Ã¡dku!</b>
            Å½Ã¡dnÃ¡ kritickÃ¡ upozornÄ›nÃ­.
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_alerts, ğŸ  Menu:/callback_menu"

  - alias: Telegram sceny seznam
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_scenes
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ¬ DostupnÃ© scÃ©ny</b>
            
            {% set scenes = states.scene | list %}
            {% if scenes | count > 0 %}
            {% for scene in scenes %}
            â€¢ {{ scene.name }}
              â”” ID: {{ scene.entity_id }}
            {% endfor %}
            
            <i>Pro spuÅ¡tÄ›nÃ­ scÃ©ny pouÅ¾ij: /scene_ID</i>
            {% else %}
            <i>Å½Ã¡dnÃ© scÃ©ny nenalezeny</i>
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_scenes, ğŸ  Menu:/callback_menu"

  - alias: Telegram automatizace seznam
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_automations
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ¤– Automatizace</b>
            
            {% set autos = states.automation | list %}
            {% if autos | count > 0 %}
            {% set on = autos | selectattr('state','eq','on') | list %}
            {% set off = autos | selectattr('state','eq','off') | list %}
            
            <b>âœ… AktivnÃ­ ({{ on|count }}):</b>
            {% if on|count > 15 %}
            ({{ on|count }} automatizacÃ­ aktivnÃ­ch)
            {% else %}
            {% for auto in on %}
            â€¢ {{ auto.name }}
            {% endfor %}
            {% endif %}
            
            {% if off|count > 0 %}
            <b>â­• VypnutÃ© ({{ off|count }}):</b>
            {% for auto in off %}
            â€¢ {{ auto.name }}
            {% endfor %}
            {% endif %}
            {% else %}
            <i>Å½Ã¡dnÃ© automatizace nenalezeny</i>
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_automations, ğŸ  Menu:/callback_menu"

  - alias: Telegram updaty
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_updates
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ†• DostupnÃ© aktualizace</b>
            
            {% set updates = states.update | selectattr('state','eq','on') | list %}
            {% if updates | count > 0 %}
            <b>ğŸ“¦ K dispozici ({{ updates|count }}):</b>
            {% for upd in updates %}
            â€¢ {{ upd.name }}
            {% if upd.attributes.installed_version is defined and upd.attributes.latest_version is defined %}
              â”” {{ upd.attributes.installed_version }} â†’ {{ upd.attributes.latest_version }}
            {% endif %}
            {% if upd.attributes.release_summary is defined %}
              â”” {{ upd.attributes.release_summary[:100] }}
            {% endif %}
            {% endfor %}
            {% else %}
            <b>âœ… VÅ¡e aktuÃ¡lnÃ­!</b>
            Å½Ã¡dnÃ© updaty k dispozici.
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_updates, ğŸ  Menu:/callback_menu"

  - alias: Telegram statistiky
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_stats
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ“ˆ Statistiky a souhrny</b>
            
            {% set energy_daily = states.sensor | selectattr('entity_id', 'search', 'daily|today') | selectattr('attributes.device_class','eq','energy') | list %}
            {% if energy_daily | count > 0 %}
            <b>âš¡ SpotÅ™eba dnes:</b>
            {% for s in energy_daily %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ {{ s.name }}: {{ s.state|float(0)|round(2) }} kWh
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set energy_monthly = states.sensor | selectattr('entity_id', 'search', 'monthly|month') | selectattr('attributes.device_class','eq','energy') | list %}
            {% if energy_monthly | count > 0 %}
            <b>âš¡ SpotÅ™eba tento mÄ›sÃ­c:</b>
            {% for s in energy_monthly %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ {{ s.name }}: {{ s.state|float(0)|round(1) }} kWh
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set temps = states.sensor | selectattr('attributes.device_class','eq','temperature') | selectattr('state','ne','unknown') | selectattr('state','ne','unavailable') | map(attribute='state') | map('float') | list %}
            {% if temps | count > 0 %}
            <b>ğŸŒ¡ PrÅ¯mÄ›rnÃ¡ teplota:</b>
            â€¢ {{ (temps|sum / temps|count)|round(1) }}Â°C
            â€¢ Min: {{ temps|min|round(1) }}Â°C
            â€¢ Max: {{ temps|max|round(1) }}Â°C
            {% endif %}
            
            <b>ğŸ“Š Aktivita dnes:</b>
            â€¢ SvÄ›tla zapnuta: {{ states.light|selectattr('state','eq','on')|list|count }}x
            â€¢ Switche aktivnÃ­: {{ states.switch|selectattr('state','eq','on')|list|count }}x
            â€¢ SpuÅ¡tÄ›nÃ© auto.: {{ states.automation|selectattr('state','eq','on')|list|count }}/{{ states.automation|list|count }}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_stats, ğŸ  Menu:/callback_menu"

  - alias: Telegram osoby detail
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_persons
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ‘¥ Kde jsou lidÃ©</b>
            
            {% set persons = states.person | list %}
            {% if persons | count > 0 %}
            {% for person in persons %}
            <b>{{ person.name }}</b>
            â€¢ Lokace: {{ person.state }}
            â€¢ ZmÄ›na: {{ relative_time(person.last_changed) }}
            {% if person.attributes.latitude is defined and person.attributes.longitude is defined %}
            â€¢ GPS: {{ person.attributes.latitude|round(4) }}, {{ person.attributes.longitude|round(4) }}
            {% endif %}
            {% if person.attributes.source is defined %}
            â€¢ Zdroj: {{ person.attributes.source }}
            {% endif %}
            
            {% endfor %}
            
            {% set home = persons | selectattr('state','eq','home') | list %}
            {% set away = persons | selectattr('state','ne','home') | list %}
            
            <b>ğŸ“Š Souhrn:</b>
            â€¢ Doma: {{ home|count }}
            â€¢ PryÄ: {{ away|count }}
            {% else %}
            <i>Å½Ã¡dnÃ© osoby nenalezeny</i>
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_persons, ğŸ  Menu:/callback_menu"

  - alias: Telegram kalendar
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_calendar
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ“… KalendÃ¡Å™ udÃ¡lostÃ­</b>
            
            {% set calendars = states.calendar | list %}
            {% if calendars | count > 0 %}
            {% for cal in calendars %}
            {% if cal.state == 'on' %}
            <b>{{ cal.name }}</b>
            {% if cal.attributes.message is defined %}
            â€¢ UdÃ¡lost: {{ cal.attributes.message }}
            {% endif %}
            {% if cal.attributes.start_time is defined %}
            â€¢ Start: {{ cal.attributes.start_time }}
            {% endif %}
            {% if cal.attributes.end_time is defined %}
            â€¢ Konec: {{ cal.attributes.end_time }}
            {% endif %}
            {% if cal.attributes.location is defined %}
            â€¢ MÃ­sto: {{ cal.attributes.location }}
            {% endif %}
            
            {% endif %}
            {% endfor %}
            
            {% set active = calendars | selectattr('state','eq','on') | list %}
            {% if active|count == 0 %}
            <i>Å½Ã¡dnÃ© probÃ­hajÃ­cÃ­ udÃ¡losti</i>
            {% endif %}
            {% else %}
            <i>Å½Ã¡dnÃ½ kalendÃ¡Å™ nenalezen</i>
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_calendar, ğŸ  Menu:/callback_menu"

  - alias: Telegram slunce
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_sun
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸŒ… Slunce a MÄ›sÃ­c</b>
            
            {% if states.sun | list | count > 0 %}
            {% set sun = states.sun[0] %}
            <b>â˜€ï¸ Slunce:</b>
            â€¢ Stav: {{ 'ğŸŒ Nad obzorem' if sun.state == 'above_horizon' else 'ğŸŒ™ Pod obzorem' }}
            {% if sun.attributes.next_rising is defined %}
            â€¢ VÃ½chod: {{ as_timestamp(sun.attributes.next_rising)|timestamp_custom('%H:%M') }}
            {% endif %}
            {% if sun.attributes.next_setting is defined %}
            â€¢ ZÃ¡pad: {{ as_timestamp(sun.attributes.next_setting)|timestamp_custom('%H:%M') }}
            {% endif %}
            {% if sun.attributes.elevation is defined %}
            â€¢ Elevace: {{ sun.attributes.elevation|round(1) }}Â°
            {% endif %}
            {% if sun.attributes.azimuth is defined %}
            â€¢ Azimut: {{ sun.attributes.azimuth|round(1) }}Â°
            {% endif %}
            {% endif %}
            
            {% set moon = states.sensor | selectattr('entity_id', 'search', 'moon') | list %}
            {% if moon | count > 0 %}
            {% for m in moon %}
            {% if 'phase' in m.entity_id and m.state != 'unknown' %}
            <b>ğŸŒ™ MÄ›sÃ­c:</b>
            â€¢ FÃ¡ze: {{ m.state }}
            {% endif %}
            {% endfor %}
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_sun, ğŸ  Menu:/callback_menu"

  - alias: Telegram notifikace
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_notifications
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ—’ï¸ AktivnÃ­ notifikace</b>
            
            {% set notifications = states.persistent_notification | list %}
            {% if notifications | count > 0 %}
            {% for notif in notifications %}
            <b>{{ notif.attributes.title if notif.attributes.title is defined else 'Notifikace' }}</b>
            â€¢ {{ notif.attributes.message if notif.attributes.message is defined else notif.state }}
            {% if notif.attributes.created_at is defined %}
            â€¢ VytvoÅ™eno: {{ relative_time(notif.attributes.created_at) }}
            {% endif %}
            
            {% endfor %}
            {% else %}
            <b>âœ… Å½Ã¡dnÃ© aktivnÃ­ notifikace</b>
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/callback_notifications, ğŸ  Menu:/callback_menu"

  # BONUS - RYCHLÃ‰ AKCE
  - alias: Telegram rychle akce menu
    trigger:
      - platform: event
        event_type: telegram_command
        event_data:
          command: /actions
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          message: "âš¡ RychlÃ© akce"
          inline_keyboard:
            - "ğŸƒ OdchÃ¡zÃ­m:/action_leaving, ğŸ›ï¸ Jdu spÃ¡t:/action_sleep"
            - "ğŸ  Jsem doma:/action_arriving, ğŸ¬ Film:/action_movie"
            - "ğŸ”„ Restart HA:/action_restart, ğŸ  Menu:/callback_menu"

  # KVALITA VZDUCHU
  - alias: Telegram kvalita vzduchu
    trigger:
      - platform: event
        event_type: telegram_command
        event_data:
          command: /air
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ’¨ Kvalita vzduchu</b>
            
            {% set co2 = states.sensor | selectattr('attributes.device_class','eq','carbon_dioxide') | list %}
            {% if co2 | count > 0 %}
            <b>CO2:</b>
            {% for s in co2 %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ {{ s.name }}: {{ s.state }} ppm
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set humidity = states.sensor | selectattr('attributes.device_class','eq','humidity') | list %}
            {% if humidity | count > 0 %}
            <b>ğŸ’§ Vlhkost:</b>
            {% for s in humidity %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ {{ s.name }}: {{ s.state }}%
            {% endif %}
            {% endfor %}
            {% endif %}
            
            {% set aqi = states.sensor | selectattr('entity_id', 'search', 'aqi|air_quality') | list %}
            {% if aqi | count > 0 %}
            <b>ğŸŒ«ï¸ AQI:</b>
            {% for s in aqi %}
            {% if s.state != 'unknown' and s.state != 'unavailable' %}
            â€¢ {{ s.name }}: {{ s.state }}
            {% endif %}
            {% endfor %}
            {% endif %}
          inline_keyboard:
            - "ğŸ”„ Refresh:/air, ğŸ  Menu:/callback_menu"

  # KAMERY
  - alias: Telegram kamery prehled
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_cameras
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ“· PÅ™ehled kamer</b>

            {% set cameras = states.camera | list %}
            {% if cameras | count > 0 %}
            <b>DostupnÃ© kamery ({{ cameras|count }}):</b>
            {% for cam in cameras %}
            â€¢ {{ cam.name }}
              {% if cam.state != 'unavailable' %}â”” Stav: {{ cam.state }}{% endif %}
              {% if cam.attributes.brand is defined %}â”” {{ cam.attributes.brand }}{% endif %}
            {% endfor %}

            <i>Pro zobrazenÃ­ snÃ­mku stiskni tlaÄÃ­tko kamery nÃ­Å¾e</i>
            {% else %}
            <i>âŒ Å½Ã¡dnÃ© kamery nenalezeny</i>
            {% endif %}
          inline_keyboard: >
            {% set cameras = states.camera | list %}
            {% set buttons = [] %}
            {% for cam in cameras %}
              {% set btn = "ğŸ“· " ~ cam.name ~ ":/callback_camera_" ~ cam.entity_id.replace('camera.','') %}
              {% set buttons = buttons + [btn] %}
            {% endfor %}
            {% if buttons|count > 0 %}
              {% for i in range(0, buttons|count, 2) %}
                {% if i+1 < buttons|count %}
                  - "{{ buttons[i] }}, {{ buttons[i+1] }}"
                {% else %}
                  - "{{ buttons[i] }}"
                {% endif %}
              {% endfor %}
            {% endif %}
            - "ğŸ”„ Refresh:/callback_cameras, ğŸ  Menu:/callback_menu"

  - alias: Telegram kamera snapshot
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/callback_camera_') }}"
    action:
      - variables:
          camera_id: "{{ trigger.event.data.command.replace('/callback_camera_', 'camera.') }}"
      - service: telegram_bot.send_photo
        data:
          target: "{{ trigger.event.data.chat_id }}"
          caption: "ğŸ“· {{ state_attr(camera_id, 'friendly_name') or camera_id }}"
          file: "/api/camera_proxy/{{ camera_id }}"
          inline_keyboard:
            - "ğŸ”„ Obnovit:/callback_camera_{{ camera_id.replace('camera.','') }}, ğŸ“· Kamery:/callback_cameras"
            - "ğŸ  Menu:/callback_menu"

  # COVERS (Å½ALUZIE/ROLETY)
  - alias: Telegram covers prehled
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_covers
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸªŸ PÅ™ehled Å¾aluziÃ­ a rolet</b>

            {% set covers = states.cover | list %}
            {% if covers | count > 0 %}
            {% for cover in covers %}
            {% if cover.state != 'unavailable' %}
            <b>{{ cover.name }}</b>
            â€¢ Stav: {% if cover.state == 'open' %}ğŸ”“ OtevÅ™eno{% elif cover.state == 'closed' %}ğŸ”’ ZavÅ™eno{% elif cover.state == 'opening' %}â¬†ï¸ OtevÃ­rÃ¡ se{% elif cover.state == 'closing' %}â¬‡ï¸ ZavÃ­rÃ¡ se{% else %}{{ cover.state }}{% endif %}
            {% if cover.attributes.current_position is defined %}â€¢ Pozice: {{ cover.attributes.current_position }}%{% endif %}
            {% if cover.attributes.current_tilt_position is defined %}â€¢ NÃ¡klon: {{ cover.attributes.current_tilt_position }}%{% endif %}

            {% endif %}
            {% endfor %}

            <b>ğŸ“Š Souhrn:</b>
            â€¢ OtevÅ™enÃ©: {{ covers | selectattr('state','eq','open') | list | count }}
            â€¢ ZavÅ™enÃ©: {{ covers | selectattr('state','eq','closed') | list | count }}
            {% else %}
            <i>âŒ Å½Ã¡dnÃ© Å¾aluzie/rolety nenalezeny</i>
            {% endif %}
          inline_keyboard: >
            {% set covers = states.cover | list %}
            {% set buttons = [] %}
            {% for cover in covers %}
              {% set btn = "ğŸªŸ " ~ cover.name ~ ":/callback_cover_ctrl_" ~ cover.entity_id.replace('cover.','') %}
              {% set buttons = buttons + [btn] %}
            {% endfor %}
            {% if buttons|count > 0 %}
              {% for i in range(0, buttons|count, 2) %}
                {% if i+1 < buttons|count %}
                  - "{{ buttons[i] }}, {{ buttons[i+1] }}"
                {% else %}
                  - "{{ buttons[i] }}"
                {% endif %}
              {% endfor %}
            {% endif %}
            - "ğŸ”„ Refresh:/callback_covers, ğŸ  Menu:/callback_menu"

  - alias: Telegram cover control menu
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/callback_cover_ctrl_') }}"
    action:
      - variables:
          cover_id: "{{ trigger.event.data.command.replace('/callback_cover_ctrl_', 'cover.') }}"
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸªŸ OvlÃ¡dÃ¡nÃ­: {{ state_attr(cover_id, 'friendly_name') or cover_id }}</b>

            â€¢ AktuÃ¡lnÃ­ stav: {% if states(cover_id) == 'open' %}ğŸ”“ OtevÅ™eno{% elif states(cover_id) == 'closed' %}ğŸ”’ ZavÅ™eno{% else %}{{ states(cover_id) }}{% endif %}
            {% if state_attr(cover_id, 'current_position') is not none %}â€¢ Pozice: {{ state_attr(cover_id, 'current_position') }}%{% endif %}

            <i>Vyber akci:</i>
          inline_keyboard:
            - "â¬†ï¸ OtevÅ™Ã­t:/cover_open_{{ cover_id.replace('cover.','') }}, â¬‡ï¸ ZavÅ™Ã­t:/cover_close_{{ cover_id.replace('cover.','') }}"
            - "â¸ï¸ Stop:/cover_stop_{{ cover_id.replace('cover.','') }}"
            - "ğŸªŸ ZpÄ›t:/callback_covers, ğŸ  Menu:/callback_menu"

  - alias: Telegram cover open
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/cover_open_') }}"
    action:
      - variables:
          cover_id: "{{ trigger.event.data.command.replace('/cover_open_', 'cover.') }}"
      - service: cover.open_cover
        target:
          entity_id: "{{ cover_id }}"
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "â¬†ï¸ OtevÃ­rÃ¡m {{ state_attr(cover_id, 'friendly_name') }}"
          show_alert: false

  - alias: Telegram cover close
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/cover_close_') }}"
    action:
      - variables:
          cover_id: "{{ trigger.event.data.command.replace('/cover_close_', 'cover.') }}"
      - service: cover.close_cover
        target:
          entity_id: "{{ cover_id }}"
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "â¬‡ï¸ ZavÃ­rÃ¡m {{ state_attr(cover_id, 'friendly_name') }}"
          show_alert: false

  - alias: Telegram cover stop
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/cover_stop_') }}"
    action:
      - variables:
          cover_id: "{{ trigger.event.data.command.replace('/cover_stop_', 'cover.') }}"
      - service: cover.stop_cover
        target:
          entity_id: "{{ cover_id }}"
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "â¸ï¸ Zastavuji {{ state_attr(cover_id, 'friendly_name') }}"
          show_alert: false

  # VENTILÃTORY
  - alias: Telegram ventilatory prehled
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_fans
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ’¨ PÅ™ehled ventilÃ¡torÅ¯</b>

            {% set fans = states.fan | list %}
            {% if fans | count > 0 %}
            {% for fan in fans %}
            {% if fan.state != 'unavailable' %}
            <b>{{ fan.name }}</b>
            â€¢ Stav: {{ 'âœ… Zapnuto' if fan.state == 'on' else 'â­• Vypnuto' }}
            {% if fan.state == 'on' %}
              {% if fan.attributes.percentage is defined and fan.attributes.percentage is not none %}â”” Rychlost: {{ fan.attributes.percentage }}%{% endif %}
              {% if fan.attributes.preset_mode is defined and fan.attributes.preset_mode is not none %}â”” ReÅ¾im: {{ fan.attributes.preset_mode }}{% endif %}
              {% if fan.attributes.oscillating is defined %}â”” Oscilace: {{ 'Ano' if fan.attributes.oscillating else 'Ne' }}{% endif %}
            {% endif %}

            {% endif %}
            {% endfor %}

            <b>ğŸ“Š Souhrn:</b>
            â€¢ ZapnutÃ©: {{ fans | selectattr('state','eq','on') | list | count }}
            â€¢ VypnutÃ©: {{ fans | selectattr('state','eq','off') | list | count }}
            {% else %}
            <i>âŒ Å½Ã¡dnÃ© ventilÃ¡tory nenalezeny</i>
            {% endif %}
          inline_keyboard: >
            {% set fans = states.fan | list %}
            {% set buttons = [] %}
            {% for fan in fans %}
              {% set btn = "ğŸ’¨ " ~ fan.name ~ ":/callback_fan_ctrl_" ~ fan.entity_id.replace('fan.','') %}
              {% set buttons = buttons + [btn] %}
            {% endfor %}
            {% if buttons|count > 0 %}
              {% for i in range(0, buttons|count, 2) %}
                {% if i+1 < buttons|count %}
                  - "{{ buttons[i] }}, {{ buttons[i+1] }}"
                {% else %}
                  - "{{ buttons[i] }}"
                {% endif %}
              {% endfor %}
            {% endif %}
            - "ğŸ”„ Refresh:/callback_fans, ğŸ  Menu:/callback_menu"

  - alias: Telegram fan control menu
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/callback_fan_ctrl_') }}"
    action:
      - variables:
          fan_id: "{{ trigger.event.data.command.replace('/callback_fan_ctrl_', 'fan.') }}"
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸ’¨ OvlÃ¡dÃ¡nÃ­: {{ state_attr(fan_id, 'friendly_name') or fan_id }}</b>

            â€¢ Stav: {{ 'âœ… Zapnuto' if states(fan_id) == 'on' else 'â­• Vypnuto' }}
            {% if state_attr(fan_id, 'percentage') is not none %}â€¢ Rychlost: {{ state_attr(fan_id, 'percentage') }}%{% endif %}
            {% if state_attr(fan_id, 'preset_mode') is not none %}â€¢ ReÅ¾im: {{ state_attr(fan_id, 'preset_mode') }}{% endif %}

            <i>Vyber akci:</i>
          inline_keyboard:
            - "âœ… Zapnout:/fan_on_{{ fan_id.replace('fan.','') }}, â­• Vypnout:/fan_off_{{ fan_id.replace('fan.','') }}"
            - "ğŸ”½ NÃ­zkÃ¡:/fan_speed_33_{{ fan_id.replace('fan.','') }}, â– StÅ™ednÃ­:/fan_speed_66_{{ fan_id.replace('fan.','') }}"
            - "ğŸ”¼ VysokÃ¡:/fan_speed_100_{{ fan_id.replace('fan.','') }}"
            - "ğŸ’¨ ZpÄ›t:/callback_fans, ğŸ  Menu:/callback_menu"

  - alias: Telegram fan turn on
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/fan_on_') }}"
    action:
      - variables:
          fan_id: "{{ trigger.event.data.command.replace('/fan_on_', 'fan.') }}"
      - service: fan.turn_on
        target:
          entity_id: "{{ fan_id }}"
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "âœ… ZapÃ­nÃ¡m {{ state_attr(fan_id, 'friendly_name') }}"
          show_alert: false

  - alias: Telegram fan turn off
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/fan_off_') }}"
    action:
      - variables:
          fan_id: "{{ trigger.event.data.command.replace('/fan_off_', 'fan.') }}"
      - service: fan.turn_off
        target:
          entity_id: "{{ fan_id }}"
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "â­• VypÃ­nÃ¡m {{ state_attr(fan_id, 'friendly_name') }}"
          show_alert: false

  - alias: Telegram fan set speed
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/fan_speed_') }}"
    action:
      - variables:
          command_parts: "{{ trigger.event.data.command.split('_') }}"
          speed: "{{ command_parts[2] | int }}"
          fan_id: "{{ trigger.event.data.command.split('_')[3:] | join('_') }}"
          full_fan_id: "fan.{{ fan_id }}"
      - service: fan.set_percentage
        target:
          entity_id: "{{ full_fan_id }}"
        data:
          percentage: "{{ speed }}"
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "ğŸ’¨ Nastavuji rychlost {{ speed }}% pro {{ state_attr(full_fan_id, 'friendly_name') }}"
          show_alert: false

  # ZVLHÄŒOVAÄŒE
  - alias: Telegram zvlhcovace prehled
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: /callback_humidifiers
    action:
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸŒ¡ï¸ PÅ™ehled zvlhÄovaÄÅ¯</b>

            {% set humidifiers = states.humidifier | list %}
            {% if humidifiers | count > 0 %}
            {% for hum in humidifiers %}
            {% if hum.state != 'unavailable' %}
            <b>{{ hum.name }}</b>
            â€¢ Stav: {{ 'âœ… Zapnuto' if hum.state == 'on' else 'â­• Vypnuto' }}
            {% if hum.state == 'on' %}
              {% if hum.attributes.current_humidity is defined and hum.attributes.current_humidity is not none %}â”” AktuÃ¡lnÃ­: {{ hum.attributes.current_humidity }}%{% endif %}
              {% if hum.attributes.humidity is defined and hum.attributes.humidity is not none %}â”” CÃ­lovÃ¡: {{ hum.attributes.humidity }}%{% endif %}
              {% if hum.attributes.mode is defined and hum.attributes.mode is not none %}â”” ReÅ¾im: {{ hum.attributes.mode }}{% endif %}
            {% endif %}

            {% endif %}
            {% endfor %}

            <b>ğŸ“Š Souhrn:</b>
            â€¢ ZapnutÃ©: {{ humidifiers | selectattr('state','eq','on') | list | count }}
            â€¢ VypnutÃ©: {{ humidifiers | selectattr('state','eq','off') | list | count }}
            {% else %}
            <i>âŒ Å½Ã¡dnÃ© zvlhÄovaÄe nenalezeny</i>
            {% endif %}
          inline_keyboard: >
            {% set humidifiers = states.humidifier | list %}
            {% set buttons = [] %}
            {% for hum in humidifiers %}
              {% set btn = "ğŸŒ¡ï¸ " ~ hum.name ~ ":/callback_hum_ctrl_" ~ hum.entity_id.replace('humidifier.','') %}
              {% set buttons = buttons + [btn] %}
            {% endfor %}
            {% if buttons|count > 0 %}
              {% for i in range(0, buttons|count, 2) %}
                {% if i+1 < buttons|count %}
                  - "{{ buttons[i] }}, {{ buttons[i+1] }}"
                {% else %}
                  - "{{ buttons[i] }}"
                {% endif %}
              {% endfor %}
            {% endif %}
            - "ğŸ”„ Refresh:/callback_humidifiers, ğŸ  Menu:/callback_menu"

  - alias: Telegram humidifier control menu
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/callback_hum_ctrl_') }}"
    action:
      - variables:
          hum_id: "{{ trigger.event.data.command.replace('/callback_hum_ctrl_', 'humidifier.') }}"
      - service: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          parse_mode: html
          message: |
            <b>ğŸŒ¡ï¸ OvlÃ¡dÃ¡nÃ­: {{ state_attr(hum_id, 'friendly_name') or hum_id }}</b>

            â€¢ Stav: {{ 'âœ… Zapnuto' if states(hum_id) == 'on' else 'â­• Vypnuto' }}
            {% if state_attr(hum_id, 'current_humidity') is not none %}â€¢ AktuÃ¡lnÃ­ vlhkost: {{ state_attr(hum_id, 'current_humidity') }}%{% endif %}
            {% if state_attr(hum_id, 'humidity') is not none %}â€¢ CÃ­lovÃ¡ vlhkost: {{ state_attr(hum_id, 'humidity') }}%{% endif %}
            {% if state_attr(hum_id, 'mode') is not none %}â€¢ ReÅ¾im: {{ state_attr(hum_id, 'mode') }}{% endif %}

            <i>Vyber akci:</i>
          inline_keyboard:
            - "âœ… Zapnout:/hum_on_{{ hum_id.replace('humidifier.','') }}, â­• Vypnout:/hum_off_{{ hum_id.replace('humidifier.','') }}"
            - "ğŸ’§ 40%:/hum_set_40_{{ hum_id.replace('humidifier.','') }}, ğŸ’§ 50%:/hum_set_50_{{ hum_id.replace('humidifier.','') }}"
            - "ğŸ’§ 60%:/hum_set_60_{{ hum_id.replace('humidifier.','') }}, ğŸ’§ 70%:/hum_set_70_{{ hum_id.replace('humidifier.','') }}"
            - "ğŸŒ¡ï¸ ZpÄ›t:/callback_humidifiers, ğŸ  Menu:/callback_menu"

  - alias: Telegram humidifier turn on
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/hum_on_') }}"
    action:
      - variables:
          hum_id: "{{ trigger.event.data.command.replace('/hum_on_', 'humidifier.') }}"
      - service: humidifier.turn_on
        target:
          entity_id: "{{ hum_id }}"
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "âœ… ZapÃ­nÃ¡m {{ state_attr(hum_id, 'friendly_name') }}"
          show_alert: false

  - alias: Telegram humidifier turn off
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/hum_off_') }}"
    action:
      - variables:
          hum_id: "{{ trigger.event.data.command.replace('/hum_off_', 'humidifier.') }}"
      - service: humidifier.turn_off
        target:
          entity_id: "{{ hum_id }}"
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "â­• VypÃ­nÃ¡m {{ state_attr(hum_id, 'friendly_name') }}"
          show_alert: false

  - alias: Telegram humidifier set humidity
    trigger:
      - platform: event
        event_type: telegram_callback
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.command.startswith('/hum_set_') }}"
    action:
      - variables:
          command_parts: "{{ trigger.event.data.command.split('_') }}"
          humidity: "{{ command_parts[2] | int }}"
          hum_id: "{{ trigger.event.data.command.split('_')[3:] | join('_') }}"
          full_hum_id: "humidifier.{{ hum_id }}"
      - service: humidifier.set_humidity
        target:
          entity_id: "{{ full_hum_id }}"
        data:
          humidity: "{{ humidity }}"
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "ğŸ’§ Nastavuji vlhkost {{ humidity }}% pro {{ state_attr(full_hum_id, 'friendly_name') }}"
          show_alert: false